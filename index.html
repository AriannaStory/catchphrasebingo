<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Catchphrase Bingo</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cherry+Cream+Soda&display=swap" rel="stylesheet">

    <style>
        .square {
            transition: background 0.2s, color 0.2s, transform 0.1s;
            min-height: 120px;
        }

        .square:hover {
            transform: scale(1.02);
        }

        .square.done {
            background-color: #374151 !important;
            color: #ffffff !important;
        }

        .square.pink {
            background-color: #ff5dd6 !important;
            color: #ffffff !important;
        }

        .square.teal {
            background-color: #65ccbb !important;
            color: #ffffff !important;
        }

        .square.split {
            background: linear-gradient(135deg, #ff5dd6 50%, #65ccbb 50%) !important;
            color: #ffffff !important;
            text-shadow: 0px 0px 2px rgba(0, 0, 0, 0.5);
        }

        .tooltip-box {
            display: none;
            position: absolute;
            z-index: 50;
        }

        .header-font {
            font-family: "Cherry Cream Soda", system-ui;
            font-weight: 400;
            font-style: normal;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

    <header class="bg-red-700 text-white py-4 text-center text-3xl font-bold tracking-wide">
        <span class="header-font">üèí Ari's Catchphrases üèà</span>
        <span class="text-base block">The Family Game of Calling Ari Out On Her Repetitiveness During Sports</span>
    </header>

    <div class="flex justify-center mt-4 space-x-4">
        <button id="generateCardBtn" class="px-4 py-2 bg-black text-white rounded shadow hover:bg-gray-800">
            Generate Card
        </button>

        <button id="gameOptionsBtn" class="px-4 py-2 bg-gray-200 rounded shadow hover:bg-gray-300">
            Game Options
        </button>
    </div>

    <div id="bingoGrid" class="grid grid-cols-5 gap-4 max-w-5xl mx-auto mt-8 px-4 md:px-0"></div>

    <div id="hoverTooltip" class="tooltip-box bg-white shadow-xl rounded-lg p-4 w-64 border border-gray-300">
        <h3 id="tooltipTitle" class="font-bold text-lg"></h3>
        <p id="tooltipDesc" class="text-sm text-gray-600 mt-1"></p>
    </div>

    <div id="gameOptionsModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-lg shadow-lg w-80 p-6">
            <h2 class="text-lg font-semibold mb-4">Game Options</h2>

            <label for="gameTypeSelect" class="block text-sm font-medium mb-1">
                Game Type
            </label>
            <select id="gameTypeSelect" class="w-full border rounded px-2 py-1 mb-4">
                <option value="nhl">NHL</option>
                <option value="nfl">NFL</option>
            </select>

            <label for="gameModeSelect" class="block text-sm font-medium mb-1">
                Game Mode
            </label>
            <select id="gameModeSelect" class="w-full border rounded px-2 py-1 mb-4">
                <option value="1p">1 Player (Classic)</option>
                <option value="2p">2 Player (Pink/Teal)</option>
            </select>

            <label for="seedInput" class="block text-sm font-medium mb-1">
                Seed (optional)
            </label>
            <input id="seedInput" type="text" class="w-full border rounded px-2 py-1 mb-4" placeholder="">

            <div class="flex justify-end space-x-2">
                <button id="gameOptionsCancel" class="px-3 py-1 rounded border border-gray-300 text-gray-700">
                    Cancel
                </button>
                <button id="gameOptionsSave" class="px-3 py-1 rounded bg-red-600 text-white">
                    Save
                </button>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-500 text-base py-6">
        Made by Arianna Story &middot; <span id="seedDisplay" class="text-gray-400"></div>
    </footer>

    <script>
        $(document).ready(function () {

            let squares = [];
            const FREE_SPACE = { title: "FREE SPACE", description: "Yay Sports! Do the Thing! Win the Points!" };

            const $grid = $("#bingoGrid");
            const $tooltip = $("#hoverTooltip");
            const $seedDisplay = $("#seedDisplay");

            let hoverTimer = null;
            let currentGameType = "nhl";
            let currentGameMode = "1p";
            let lastUsedSeed = null;

            function escapeHTML(str) {
                return String(str)
                    .replace(/&/g, "&amp;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#39;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            $.getJSON("squares.json", function (data) {
                squares = data;

                currentGameType = localStorage.getItem("bingoGameType") || "nhl";
                currentGameMode = localStorage.getItem("bingoGameMode") || "1p";

                const savedCard = localStorage.getItem("bingoCard");
                const savedDone = localStorage.getItem("bingoCardDone");
                const savedSeed = localStorage.getItem("bingoSeed");

                if (savedCard) {
                    lastUsedSeed = savedSeed ? savedSeed : null;
                    updateSeedDisplay();
                    renderCard(JSON.parse(savedCard), JSON.parse(savedDone || "{}"));
                } else {
                    generateCard(undefined);
                }
            });

            function getFilteredSquares() {
                return squares.filter(sq =>
                    sq.type === "*" ||
                    (sq.type && sq.type.toLowerCase() === currentGameType.toLowerCase())
                );
            }

            function mulberry32(seed) {
                let t = seed >>> 0;
                return function () {
                    t += 0x6D2B79F5;
                    let r = Math.imul(t ^ t >>> 15, t | 1);
                    r ^= r + Math.imul(r ^ r >>> 7, r | 61);
                    return ((r ^ r >>> 14) >>> 0) / 4294967296;
                };
            }

            function seededShuffle(array, rng) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(rng() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function generateCard(seedArg = undefined) {
                let rng = null;

                if (seedArg !== undefined && seedArg !== null && seedArg !== "") {
                    lastUsedSeed = String(seedArg);
                    localStorage.setItem("bingoSeed", lastUsedSeed);
                    rng = mulberry32(Number(lastUsedSeed));
                }

                else if (seedArg === undefined) {
                    lastUsedSeed = String(Math.floor(Math.random() * 1_000_000_000));
                    localStorage.setItem("bingoSeed", lastUsedSeed);
                    rng = mulberry32(Number(lastUsedSeed));
                }

                else {
                    lastUsedSeed = null;
                    localStorage.removeItem("bingoSeed");
                    rng = Math.random;
                }

                updateSeedDisplay();

                const filtered = getFilteredSquares();
                if (filtered.length < 24) {
                    alert("Not enough squares available for this game type.");
                    return;
                }

                const pool = [...filtered];

                if (lastUsedSeed !== null) {
                    seededShuffle(pool, rng);
                } else {
                    for (let i = pool.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [pool[i], pool[j]] = [pool[j], pool[i]];
                    }
                }

                const selected = pool.slice(0, 24);

                const cardData = [];
                let idx = 0;

                for (let i = 0; i < 25; i++) {
                    if (i === 12) cardData.push(FREE_SPACE);
                    else cardData.push(selected[idx++]);
                }

                localStorage.setItem("bingoGameType", currentGameType);
                localStorage.setItem("bingoGameMode", currentGameMode);
                localStorage.setItem("bingoCard", JSON.stringify(cardData));
                localStorage.setItem("bingoCardDone", "{}");

                renderCard(cardData, {});
            }

            function updateSeedDisplay() {
                if (lastUsedSeed !== null) {
                    $seedDisplay.text(lastUsedSeed);
                } else {
                    $seedDisplay.text("");
                }
            }

            function renderCard(cardData, doneState) {
                $grid.empty();

                cardData.forEach((sq, i) => {
                    let state = doneState[i];
                    if (state === true) state = 1;
                    if (!state) state = 0;

                    let colorClass = "";
                    if (currentGameMode === "2p") {
                        if (state === 1) colorClass = "pink";
                        else if (state === 2) colorClass = "teal";
                        else if (state === 3) colorClass = "split";
                    } else {
                        if (state > 0) colorClass = "done";
                    }

                    const safeTitle = escapeHTML(sq.title);
                    const safeDesc = escapeHTML(sq.description);

                    const $square = $(`
                <div class="square bg-white rounded-lg shadow border border-gray-200
                            cursor-pointer flex items-center justify-center
                            text-center px-3 py-6 md:py-8 text-sm md:text-base leading-snug ${colorClass}"
                     data-index="${i}"
                     data-title="${safeTitle}"
                     data-desc="${safeDesc}">
                    <span class="break-words">${safeTitle}</span>
                </div>
            `);

                    $square.on("click", function () {
                        const idx = $(this).data("index");
                        const updated = JSON.parse(localStorage.getItem("bingoCardDone") || "{}");

                        let currentState = updated[idx];
                        if (currentState === true) currentState = 1;
                        if (!currentState) currentState = 0;

                        let newState;
                        if (currentGameMode === "2p") {
                            newState = (currentState + 1) % 4;
                        } else {
                            newState = currentState > 0 ? 0 : 1;
                        }

                        updated[idx] = newState;

                        localStorage.setItem("bingoCardDone", JSON.stringify(updated));

                        $(this).removeClass("pink teal split done");

                        if (currentGameMode === "2p") {
                            if (newState === 1) $(this).addClass("pink");
                            else if (newState === 2) $(this).addClass("teal");
                            else if (newState === 3) $(this).addClass("split");
                        } else {
                            if (newState > 0) $(this).addClass("done");
                        }
                    });

                    $square.on("mouseenter", function () {
                        const self = this;
                        clearTimeout(hoverTimer);
                        hoverTimer = setTimeout(() => {
                            $("#tooltipTitle").text($(self).data("title"));
                            $("#tooltipDesc").text($(self).data("desc"));
                            $tooltip.show();
                        }, 800);
                    });

                    $square.on("mousemove", function (e) {
                        $tooltip.css({ top: e.pageY + 15, left: e.pageX + 15 });
                    });

                    $square.on("mouseleave", function () {
                        clearTimeout(hoverTimer);
                        $tooltip.hide();
                    });

                    $grid.append($square);
                });
            }

            $("#generateCardBtn").click(() => generateCard(undefined));

            $("#gameOptionsBtn").click(function () {
                $("#gameTypeSelect").val(currentGameType);
                $("#gameModeSelect").val(currentGameMode);
                $("#seedInput").val("");
                $("#gameOptionsModal").removeClass("hidden");
            });

            $("#gameOptionsCancel").click(function () {
                $("#gameOptionsModal").addClass("hidden");
            });

            $("#gameOptionsSave").click(function () {
                const oldType = currentGameType;
                currentGameType = $("#gameTypeSelect").val() || "nhl";
                const typeChanged = oldType !== currentGameType;

                const newMode = $("#gameModeSelect").val() || "1p";
                const modeChanged = newMode !== currentGameMode;
                currentGameMode = newMode;
                localStorage.setItem("bingoGameMode", currentGameMode);

                const enteredSeed = $("#seedInput").val().trim();
                $("#seedInput").val("");
                $("#gameOptionsModal").addClass("hidden");

                if (enteredSeed) {
                    generateCard(enteredSeed);
                } else if (modeChanged && !typeChanged) {
                    const savedCard = localStorage.getItem("bingoCard");
                    const savedDone = localStorage.getItem("bingoCardDone");
                    if (savedCard) {
                        renderCard(JSON.parse(savedCard), JSON.parse(savedDone || "{}"));
                    } else {
                        generateCard("");
                    }
                } else {
                    generateCard("");
                }
            });

        });
    </script>
</body>

</html>